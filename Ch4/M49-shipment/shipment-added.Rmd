---
title: "Shipment"  
author: "learningSpoons"  
date: "`r Sys.Date()`"  
output: 
  html_document:
    toc: true  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

+ Task 1. 아래에 사용할 패키지를 로드하세요.  

```{r, message = FALSE}
library(dplyr)
library(stringr)
library(ggplot2)
library(reshape2)
```

## 1. 불러오기  

```{r}
shipment <- read.csv("shipment.csv", stringsAsFactors = FALSE)
str(shipment)
```

## 2. 전처리  

+ Task 2. 변수들을 필요에 따라 `Date`, `factor`등으로 변경하세요.

## 3. 그래픽 (Part 1)     

+ Task 3. 판매량 추이  
+ Task 4. 채널별 판매량 추이  

![](page1.png)  

## 4. 그래픽 (Part 2)  

+ Task 5. 제품별 판매량 비교  
+ Task 6. 월별 판매 제품 비율  
+ Task 7. 판매자별 제품 판매량 추이  

![](page2.png)

## 5. 분석  

+ 고객의 구매 패턴을 파악하여 SNS 마케팅 전략 수립하기  
+ 특정 상품의 판매 주기와 지역별 수요를 파악하여 재고 관리 전략 수립하기  
+ 매출 추이를 확인하고 간단한 매출 목표 수립하기  
+ 동시 구매가 많이 일어나는 상품을 파악하여 프로모션 기획  
+ 배송 메모 텍스트 분석  

## 6. Sim - 동시 구매 상품 처리   

+ (이 분석은 전처리 난이도 상급에 해당합니다.)  
+ Fact  
 1. 품번과 품명은 1:1로 대응된다. - 이전 파일에서 `unique(shipment$품번)`와 `unique(shipment$품명)`을 실행해보면 알 수 있음.   
 2. 첫 번째 관찰값을 살펴보면, `head(shipment$품번, 1)=` `r head(shipment$품번, 1)` 이므로, 각각의 아이템에 대해서 "/"로 구분되어 있다는 것을 알 수 있다.  

```{r}
head(shipment$품번, 1)
```

+ Fact  
  3. 구분자는 "/"이므로, 이를 각각 분리해야 하고, 각각의 구매 기록에 대해서 어떤 아이템이 판매되었는지 본다.  

```{r}
uniqueSKU <- shipment$품번 %>% 
  str_split("/") %>% # SPLIT the STRING by the PATTERN ("/")  
  unlist() %>% unique() # unlist everything and find the distinct elements  
head(uniqueSKU)
```

  5. 아! 이해했다! "품번"은 `"SKU" + "|FREE|" + blahblah + "*" + 수량`으로 되어있으며, 동시 구매 상품을 파악하기 위해서는 `"SKU"` (Stock Keeping Number)부분을 떼어서 분석해야 한다.   
  6. 그렇다면, 다음과 같은 명령으로 진정한 의미의 `uniqueSKU`를 찾아낼 수 있다.  

```{r}
uniqueSKU <- uniqueSKU %>%   
  str_split("[|]") %>% # SPLIT the STRING by the PATTERN ("|")
  lapply(function(x) x[1]) %>% # From each VECTOR in a LIST, TAKE the FIRST element  
  unlist() %>% unique() # unlist everything and find the distinct elements  
uniqueSKU <- uniqueSKU[!uniqueSKU==""]
uniqueSKU
```

+ Task Specification  
  1. `GGplot-50examples`의 12페이지를 우선 이해하세요.
  2. 해당 예제에서는 `corr`이라는 객체를 생성하고, 그림을 그립니다.  
  3. `corr`의 객체를 예제를 paste하여 생성해보세요. 어떤 구조인가요?  

```{r, eval=FALSE}
# from M91
data(mtcars)
corr <- round(cor(mtcars), 1)
corr  
```

  4. 이와 같이 우리는 우선 한변이 uniqueSKU의 길이가 되는 정사각형의 데이터 구조를 만들고 동시 구매 횟수를 기록해야 합니다.   
  5. 그 이후로 그림은 뭔가 비슷한 방법을 이용해서 그리면 되겠죠?    
  6. 우선 우리의 데이터로 "정사각표"를 만들어 보겠습니다.   
  
```{r}  
purchase <- array(0, c(length(uniqueSKU), length(uniqueSKU)))
colnames(purchase) <- uniqueSKU
rownames(purchase) <- uniqueSKU
for (i in 1:length(uniqueSKU)) {
  for (j in 1:length(uniqueSKU)) {
    purchase[i,j] <- 
      sum(str_detect(shipment$품번, uniqueSKU[i]) & str_detect(shipment$품번, uniqueSKU[j]))
  }
}
```

```{r}
purchaseSet1 <- purchase[1:10,1:10]
fig1104<- ggplot(melt(purchaseSet1), aes(Var1, Var2, fill = value, label = value)) +
  geom_tile() +
  geom_text(size=4) + 
  scale_fill_gradient2(low="blue", mid="white", high="red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_equal()
print(fig1104)
## Further readings:
## https://www.worldfullofdata.com/code-visualize-correlation-matrix-r/
```

```{r}
purchasePortion <- array(0, c(length(uniqueSKU), length(uniqueSKU)))
colnames(purchasePortion) <- uniqueSKU
rownames(purchasePortion) <- uniqueSKU
for (i in 1:length(uniqueSKU)) {
  purchasePortion[i,] <- purchase[i,]/purchase[i,i]
}
purchasePortion <- round(purchasePortion*100, 0)
```

```{r}
fig1105<- ggplot(melt(purchasePortion[1:10,1:10]), aes(Var1, Var2, fill = value, label = value)) +
  geom_tile() +
  geom_text(size=3) + 
  scale_fill_gradient2(low="blue", mid="white", high="red") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  coord_equal()
print(fig1105)
```